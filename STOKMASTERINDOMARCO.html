<!DOCTYPE html>
<html lang="id" class="dark"> <!-- Force dark mode for the futuristic theme -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Stok dan Pengiriman PT Indomarco Prismatama</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- SheetJS (XLSX) Library for Excel Import/Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --neon-cyan: #00f6ff;
            --neon-pink: #ff00ff;
            --bg-dark-start: #0f0c29;
            --bg-dark-mid: #302b63;
            --bg-dark-end: #24243e;
            --glass-bg: rgba(20, 20, 40, 0.6);
            --border-color: rgba(148, 112, 224, 0.3);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, var(--bg-dark-start), var(--bg-dark-mid), var(--bg-dark-end));
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #e0e0e0;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass-container {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .neon-text {
            text-shadow: 0 0 5px var(--neon-cyan), 0 0 10px var(--neon-cyan);
        }

        .tab-btn.active {
            color: var(--neon-cyan);
            border-color: var(--neon-cyan);
            text-shadow: 0 0 8px var(--neon-cyan);
        }

        .control-btn {
            border: 1px solid transparent;
            background-image: linear-gradient(45deg, var(--neon-pink), var(--neon-cyan));
            background-origin: border-box;
            background-clip: padding-box, border-box;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 246, 255, 0.5), 0 0 20px rgba(255, 0, 255, 0.5);
        }
        .control-btn:hover {
            box-shadow: 0 0 15px rgba(0, 246, 255, 0.8), 0 0 30px rgba(255, 0, 255, 0.8);
            transform: translateY(-2px);
        }

        .modal-input {
            background: rgba(0,0,0,0.3) !important;
            border-color: var(--border-color) !important;
        }
        .modal-input:focus {
            border-color: var(--neon-cyan) !important;
            box-shadow: 0 0 10px var(--neon-cyan) !important;
            ring: 0 !important;
        }

        #toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
       
        .modal-display-field {
            background-color: rgba(0,0,0,0.3);
        }
       
        .low-stock-warning {
             background-color: rgba(220, 38, 38, 0.15); /* red-600 with opacity */
        }
       
        .sortable-header:hover {
            background-color: rgba(255,255,255,0.1);
        }

        /* Print styles remain the same */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
            table { font-size: 11px; }
            h1, h2, h3 { color: black !important; }
        }
    </style>
    <script>
        // Force dark mode in Tailwind config
        tailwind.config = { darkMode: 'class' }
    </script>
</head>
<body class="dark">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 z-50 flex items-center justify-center">
        <div class="w-full max-w-sm p-8 space-y-6 rounded-lg text-center glass-container">
             <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-slate-800/50 border border-cyan-500/50 shadow-[0_0_15px_rgba(0,246,255,0.5)]">
                <svg class="h-12 w-12 text-cyan-400 neon-text" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
             </div>
            <h2 class="text-2xl font-bold text-white">Sistem Stok & Pengiriman <br><span class="text-cyan-400">PT Indomarco Prismatama</span></h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="modal-label text-left">Username</label>
                    <input type="text" id="username" class="modal-input" required>
                </div>
                <div>
                    <label for="password" class="modal-label text-left">Password</label>
                    <input type="password" id="password" class="modal-input" required>
                </div>
                <p id="login-error" class="text-sm text-red-400 text-center h-4"></p>
                <button type="submit" class="w-full px-4 py-2.5 text-white rounded-lg font-semibold control-btn">
                    Masuk
                </button>
            </form>
            <p class="text-center text-gray-400 text-xs mt-4">Powered By Andi Triyanto</p>
        </div>
    </div>


    <div id="main-app" class="container mx-auto p-4 sm:p-6 lg:p-8 hidden">
        
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 no-print">
              <div class="flex items-center gap-4">
                  <div>
                      <h1 class="text-2xl font-bold text-white">Sistem Stok dan Pengiriman <span class="text-cyan-400">PT Indomarco Prismatama</span></h1>
                      <p class="text-slate-400 mt-1">Gudang Utama - <span id="current-date"></span></p>
                  </div>
              </div>
            <div class="flex items-center gap-2 mt-4 sm:mt-0">
                <button id="logout-btn" class="p-2 rounded-full hover:bg-slate-700/50 text-slate-300 hover:text-cyan-400 transition-colors" title="Logout">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="glass-container rounded-2xl p-6">
              <!-- Tabs -->
            <div class="border-b border-slate-700 mb-5 no-print">
                <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs">
                    <button class="tab-btn active shrink-0" data-tab="dashboard">Dashboard</button>
                    <button class="tab-btn shrink-0" data-tab="stock">Laporan Stok</button>
                    <button class="tab-btn shrink-0" data-tab="sales">Laporan Pengiriman</button>
                    <button class="tab-btn shrink-0" data-tab="forecast">Forecast</button>
                    <button class="tab-btn shrink-0" data-tab="allocation">Alokasi Gudang</button>
                    <button class="tab-btn admin-only shrink-0" data-tab="prices">Pengaturan Harga</button>
                    <button class="tab-btn admin-only shrink-0" data-tab="users">Pengaturan Pengguna</button>
                </nav>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard-view">
                <h2 class="text-2xl font-bold mb-6 text-center text-white">Dashboard Stok Gudang</h2>
                <div id="dashboard-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Dashboard content (summary cards) will be generated here -->
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                    <div class="glass-container p-4 rounded-lg">
                       <h3 class="text-lg font-semibold mb-4 text-center">Total Barang Masuk</h3>
                       <canvas id="total-in-chart"></canvas>
                   </div>
                    <div class="glass-container p-4 rounded-lg">
                       <h3 class="text-lg font-semibold mb-4 text-center">Persentase Total Kiriman</h3>
                       <canvas id="total-sold-chart"></canvas>
                   </div>
                </div>
            </div>
            
            <!-- Stock View -->
            <div id="stock-view" class="hidden print-area">
                 <!-- Controls -->
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-5 no-print">
                    <div class="relative w-full sm:w-auto">
                        <input type="text" id="search-input" placeholder="Cari barang..." class="w-full sm:w-64 pl-10 pr-4 py-2 rounded-lg modal-input">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <div class="grid grid-cols-2 sm:flex sm:flex-wrap justify-end gap-3">
                        <button id="add-stock-btn" class="control-btn admin-only">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            <span>Tambah Stok Masuk</span>
                        </button>
                        <button id="record-sale-btn" class="control-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                            <span>Catat Pengiriman</span>
                        </button>
                         <button id="import-stock-btn" class="control-btn admin-only" title="Impor Laporan Stok dari Excel">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                              <span>Impor Stok</span>
                         </button>
                        <button id="export-stock-btn" class="control-btn admin-only" title="Ekspor Laporan Stok">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                              <span>Ekspor Stok</span>
                        </button>
                        <button id="print-stock-btn" class="control-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                            <span>Cetak</span>
                        </button>
                        <input type="file" id="import-stock-file-input" class="hidden" accept=".xlsx, .xls">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <h2 class="text-xl font-semibold mb-4 text-center text-white">Laporan Stok Barang (Total Semua Gudang)</h2>
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs uppercase bg-slate-900/50 text-gray-300">
                            <tr>
                                <th scope="col" class="px-4 py-3">No</th>
                                <th scope="col" class="px-4 py-3 sortable-header" data-sort-by="code">Kode</th>
                                <th scope="col" class="px-6 py-3 sortable-header" data-sort-by="name">Nama Barang</th>
                                <th scope="col" class="px-4 py-3 text-center sortable-header" data-sort-by="totalIn">Total Masuk</th>
                                <th scope="col" class="px-4 py-3 text-center sortable-header" data-sort-by="totalSold">Total Keluar</th>
                                <th scope="col" class="px-4 py-3 text-center sortable-header" data-sort-by="finalStock">Total Stok Akhir</th>
                                <th scope="col" class="px-4 py-3">Satuan</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table-body"></tbody>
                    </table>
                    <p id="no-stock-data-message" class="text-center py-8 text-gray-500 hidden">Belum ada data barang.</p>
                </div>

                <div class="overflow-x-auto mt-10">
                    <h2 class="text-xl font-semibold mb-4 text-center text-white">Riwayat Pemasukan Stok</h2>
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs uppercase bg-slate-900/50 text-gray-300">
                            <tr>
                                <th scope="col" class="px-4 py-3">No</th>
                                <th scope="col" class="px-6 py-3">Tanggal</th>
                                <th scope="col" class="px-4 py-3">Kode Barang</th>
                                <th scope="col" class="px-6 py-3">Nama Barang</th>
                                <th scope="col" class="px-6 py-3">Gudang</th>
                                <th scope="col" class="px-4 py-3 text-center">Jumlah Masuk</th>
                                <th scope="col" class="px-4 py-3 text-center no-print admin-only">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="stock-entry-history-table-body"></tbody>
                    </table>
                     <p id="no-stock-entry-message" class="text-center py-8 text-gray-500 hidden">Belum ada riwayat pemasukan stok.</p>
                </div>
            </div>

            <!-- Sales View -->
            <div id="sales-view" class="hidden print-area">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-5 no-print">
                    <h3 class="text-xl font-semibold text-white w-full sm:w-auto">Riwayat Pengiriman</h3>
                     <div class="grid grid-cols-2 sm:flex sm:flex-wrap justify-end gap-3">
                           <button id="import-sales-btn" class="control-btn admin-only" title="Impor & Tambah data pengiriman dari file Excel">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                              <span>Impor Pengiriman</span>
                           </button>
                           <button id="export-sales-btn" class="control-btn" title="Ekspor data pengiriman saja">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                              <span>Ekspor Pengiriman</span>
                           </button>
                           <button id="print-sales-btn" class="control-btn">
                               <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                               <span>Cetak</span>
                           </button>
                           <input type="file" id="import-sales-file-input" class="hidden" accept=".xlsx, .xls">
                     </div>
                </div>

                <!-- Sales Summary -->
                <div id="sales-summary-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 no-print">
                    <!-- Summary cards will be injected here -->
                </div>

                 <div class="overflow-x-auto">
                    <h2 class="text-xl font-semibold mb-4 text-center text-white">Laporan Pengiriman</h2>
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs uppercase bg-slate-900/50 text-gray-300">
                            <tr>
                                <th scope="col" class="px-4 py-3">No</th>
                                <th scope="col" class="px-6 py-3 sortable-header" data-sort-by="date">Tanggal</th>
                                <th scope="col" class="px-6 py-3">No. PO</th>
                                <th scope="col" class="px-6 py-3">No. SJ</th>
                                <th scope="col" class="px-6 py-3 sortable-header" data-sort-by="customer">Pelanggan</th>
                                <th scope="col" class="px-6 py-3">Gudang</th>
                                <th scope="col" class="px-4 py-3">Kode</th>
                                <th scope="col" class="px-6 py-3 sortable-header" data-sort-by="itemName">Nama Barang</th>
                                <th scope="col" class="px-6 py-3">Keterangan</th>
                                <th scope="col" class="px-4 py-3 text-right">Harga Satuan</th>
                                <th scope="col" class="px-4 py-3 text-center sortable-header" data-sort-by="quantity">Qty</th>
                                <th scope="col" class="px-4 py-3 text-right sortable-header" data-sort-by="totalPrice">Total Harga</th>
                                <th scope="col" class="px-4 py-3 no-print admin-only">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="sales-table-body"></tbody>
                    </table>
                    <p id="no-sales-data-message" class="text-center py-8 text-gray-500 hidden">Belum ada data pengiriman.</p>
                </div>
            </div>

            <!-- Forecast View -->
            <div id="forecast-view" class="hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-5 no-print">
                    <h3 class="text-xl font-semibold text-white w-full sm:w-auto">Forecast Pengiriman per Lokasi</h3>
                    <div class="grid grid-cols-2 sm:flex sm:flex-wrap justify-end gap-3">
                        <button id="import-forecast-btn" class="control-btn admin-only" title="Impor Forecast dari Excel">
                           <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                            <span>Impor Forecast</span>
                        </button>
                        <button id="export-forecast-btn" class="control-btn" title="Ekspor Forecast ke Excel">
                           <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            <span>Ekspor Forecast</span>
                        </button>
                        <button id="save-forecast-btn" class="control-btn admin-only">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                            <span>Simpan Forecast</span>
                        </button>
                        <input type="file" id="import-forecast-file-input" class="hidden" accept=".xlsx, .xls">
                    </div>
                </div>
                <div class="overflow-x-auto">
                     <table class="w-full text-sm text-left text-gray-400">
                         <thead class="text-xs uppercase bg-slate-900/50 text-gray-300">
                             <tr>
                                 <th scope="col" rowspan="2" class="px-6 py-3 align-bottom">Lokasi (DC)</th>
                                 <th scope="col" colspan="5" class="px-6 py-3 text-center border-b border-l border-r border-slate-700">DC Khenaizi 250g</th>
                                 <th scope="col" colspan="5" class="px-6 py-3 text-center border-b border-l border-slate-700">DC Khalas Rigid 250g</th>
                             </tr>
                             <tr>
                                 <th class="px-2 py-2 text-center border-l border-slate-700">Wilayah Gudang</th>
                                 <th class="px-2 py-2 text-center">Forecast</th>
                                 <th class="px-2 py-2 text-center">Terkirim</th>
                                 <th class="px-2 py-2 text-center">Sisa</th>
                                 <th class="px-2 py-2 text-center border-r border-slate-700">Pencapaian</th>
                                 <th class="px-2 py-2 text-center border-l border-slate-700">Wilayah Gudang</th>
                                 <th class="px-2 py-2 text-center">Forecast</th>
                                 <th class="px-2 py-2 text-center">Terkirim</th>
                                 <th class="px-2 py-2 text-center">Sisa</th>
                                 <th class="px-2 py-2 text-center">Pencapaian</th>
                             </tr>
                         </thead>
                         <tbody id="forecast-table-body"></tbody>
                     </table>
                </div>
                <div class="overflow-x-auto mt-10">
                    <h3 class="text-xl font-semibold mb-4 text-center text-white">Total Forecast per Wilayah Gudang</h3>
                    <table id="gudang-summary-table" class="w-full text-sm text-left text-gray-400">
                        <!-- Header and body will be generated by JS -->
                    </table>
                </div>
            </div>
            
            <!-- Gudang Allocation View -->
            <div id="allocation-view" class="hidden">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                     <h2 class="text-2xl font-bold text-white">Alokasi Stok Gudang Wilayah</h2>
                     <div class="grid grid-cols-2 sm:flex sm:flex-wrap justify-end gap-3">
                          <button id="import-allocation-btn" class="control-btn admin-only">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                            <span>Impor Alokasi</span>
                          </button>
                          <button id="export-allocation-btn" class="control-btn">
                              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                              <span>Ekspor Alokasi</span>
                          </button>
                         <button id="save-allocation-btn" class="control-btn admin-only">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                             <span>Simpan Alokasi</span>
                         </button>
                     </div>
                 </div>
                 <div class="overflow-x-auto">
                     <table class="w-full text-sm text-left text-gray-400">
                         <thead class="text-xs uppercase bg-slate-900/50 text-gray-300">
                             <tr>
                                 <th scope="col" rowspan="2" class="px-6 py-3 align-bottom">Wilayah Gudang</th>
                                 <th scope="col" colspan="2" class="px-6 py-3 text-center border-b border-l border-r border-slate-700">DC Khenaizi 250g</th>
                                 <th scope="col" colspan="2" class="px-6 py-3 text-center border-b border-l border-slate-700">DC Khalas Rigid 250g</th>
                             </tr>
                             <tr>
                                 <th class="px-2 py-2 text-center border-l border-slate-700">Kebutuhan Forecast</th>
                                 <th class="px-2 py-2 text-center border-r border-slate-700">Alokasi Masuk</th>
                                 <th class="px-2 py-2 text-center border-l border-slate-700">Kebutuhan Forecast</th>
                                 <th class="px-2 py-2 text-center border-r border-slate-700">Alokasi Masuk</th>
                             </tr>
                         </thead>
                         <tbody id="allocation-table-body">
                             <!-- Allocation table content will be generated here -->
                         </tbody>
                     </table>
                 </div>
            </div>

            <!-- Users View -->
            <div id="users-view" class="hidden">
                <h2 class="text-2xl font-bold mb-6 text-center text-white">Pengaturan Pengguna</h2>
                
                <div class="max-w-md mx-auto mb-10">
                    <h3 class="text-lg font-semibold mb-4">Tambah Pengguna Baru</h3>
                    <form id="add-user-form" class="space-y-4 p-6 glass-container rounded-lg">
                        <div>
                            <label for="new-username" class="modal-label">Username Baru</label>
                            <input type="text" id="new-username" class="modal-input" required>
                        </div>
                        <div>
                            <label for="new-password" class="modal-label">Password Baru</label>
                            <input type="password" id="new-password" class="modal-input" required>
                        </div>
                        <div>
                            <label for="new-user-role" class="modal-label">Peran</label>
                            <select id="new-user-role" class="modal-input">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full control-btn">Tambah Pengguna</button>
                    </form>
                </div>

                <div class="overflow-x-auto">
                    <h3 class="text-lg font-semibold mb-4">Daftar Pengguna</h3>
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs uppercase bg-slate-900/50 text-gray-300">
                            <tr>
                                <th class="px-6 py-3">Username</th>
                                <th class="px-6 py-3">Peran</th>
                                <th class="px-6 py-3">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- User list will be generated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Prices View -->
            <div id="prices-view" class="hidden">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-white">Pengaturan Harga per Pelanggan (DC)</h2>
                    <div class="grid grid-cols-2 sm:flex sm:flex-wrap justify-end gap-3">
                        <button id="import-prices-btn" class="control-btn admin-only" title="Impor Harga dari Excel">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                            <span>Impor</span>
                        </button>
                        <button id="export-prices-btn" class="control-btn admin-only" title="Ekspor Harga ke Excel">
                           <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                           <span>Ekspor</span>
                        </button>
                        <button id="save-customer-prices-btn" class="control-btn admin-only">Simpan Harga</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead id="customer-prices-table-head" class="text-xs uppercase bg-slate-900/50 text-gray-300">
                            <!-- Headers generated by JS -->
                        </thead>
                        <tbody id="customer-prices-table-body">
                            <!-- Price inputs will be generated here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
        
        <footer class="mt-8 text-center text-gray-400 text-sm no-print">Powered By Andi Triyanto</footer>
    </div>

    <!-- Modals -->
    <div id="item-modal" class="modal-container hidden">
        <div class="modal-content max-w-2xl glass-container">
            <div class="modal-header">
                <h3 id="item-modal-title" class="text-xl font-semibold">Tambah Stok Masuk</h3>
                <button class="close-modal-btn">&times;</button>
            </div>
            <form id="item-form" class="p-6">
                <input type="hidden" id="stock-entry-id">
                <div class="space-y-4">
                     <div id="item-details-section" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                          <div>
                               <label for="item-date" class="modal-label">Tanggal</label>
                               <input type="date" id="item-date" class="modal-input" required>
                          </div>
                          <div>
                               <label for="item-code" class="modal-label">Kode Barang</label>
                               <select id="item-code" class="modal-input" required>
                                   <option value="KHZ">KHZ</option>
                                   <option value="RGD">RGD</option>
                               </select>
                          </div>
                          <div>
                            <label for="item-name" class="modal-label">Nama Barang</label>
                            <select id="item-name" class="modal-input" required>
                                <option value="DC Khenaizi 250g">DC Khenaizi 250g</option>
                                <option value="DC Khalas Rigid 250g">DC Khalas Rigid 250g</option>
                            </select>
                        </div>
                     </div>
                    <div id="item-extra-details-section" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div>
                             <label for="item-unit" class="modal-label">Satuan</label>
                             <input type="text" id="item-unit" placeholder="Pcs, Kg, Box" class="modal-input">
                         </div>
                         <div>
                             <label for="item-price" class="modal-label">Harga Jual Default (Rp)</label>
                             <input type="number" id="item-price" class="modal-input" min="0" value="0">
                         </div>
                    </div>
                    <div id="warehouse-section" class="pt-4 border-t border-slate-700">
                        <p class="modal-label mb-2">Stok Gudang</p>
                        <div id="warehouse-stock-inputs" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                            <!-- Warehouse inputs will be generated here by JS -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer mt-6">
                    <button type="button" class="cancel-modal-btn">Batal</button>
                    <button type="submit" class="px-4 py-2 rounded-lg control-btn">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="sale-modal" class="modal-container hidden">
         <div class="modal-content max-w-lg glass-container">
            <div class="modal-header">
                <h3 class="text-xl font-semibold">Catat Pengiriman</h3>
                <button class="close-modal-btn">&times;</button>
            </div>
            <form id="sale-form" class="p-6">
                <div class="space-y-4">
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <div>
                               <label for="sale-customer-name" class="modal-label">Nama Pelanggan</label>
                               <select id="sale-customer-name" class="modal-input" required>
                                   <!-- Customer options will be generated here by JS -->
                               </select>
                          </div>
                          <div>
                               <label for="sale-date" class="modal-label">Tanggal Pengiriman</label>
                               <input type="date" id="sale-date" class="modal-input" required>
                          </div>
                     </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="sale-po-number" class="modal-label">Nomor PO</label>
                            <input type="text" id="sale-po-number" class="modal-input" placeholder="Opsional">
                        </div>
                        <div>
                            <label for="sale-sj-number" class="modal-label">Nomor SJ</label>
                            <input type="text" id="sale-sj-number" class="modal-input" placeholder="Opsional">
                        </div>
                    </div>
                    <div>
                        <label for="sale-keterangan" class="modal-label">Keterangan</label>
                        <input type="text" id="sale-keterangan" class="modal-input" placeholder="Catatan (opsional)">
                    </div>
                     <div>
                         <label for="sale-warehouse" class="modal-label">Ambil Dari Gudang</label>
                         <select id="sale-warehouse" class="modal-input" required>
                              <!-- Warehouse options will be generated here by JS -->
                         </select>
                     </div>
                    <div>
                        <label for="sale-item-id" class="modal-label">Pilih Barang</label>
                        <select id="sale-item-id" class="modal-input" required></select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="modal-label">Harga Satuan</label>
                            <p id="sale-item-price-display" class="modal-display-field">Rp 0</p>
                        </div>
                        <div>
                            <label for="sale-quantity" class="modal-label">Jumlah (Qty)</label>
                            <input type="number" id="sale-quantity" class="modal-input" min="1" value="1" required>
                        </div>
                    </div>
                    <div>
                        <label class="modal-label">Total Harga</label>
                        <p id="sale-total-price-display" class="modal-display-field text-lg font-bold">Rp 0</p>
                    </div>
                     <p id="available-stock-info" class="text-xs text-gray-400 mt-1"></p>
                </div>
                <div class="modal-footer mt-4">
                    <button type="button" class="cancel-modal-btn">Batal</button>
                    <button type="submit" class="px-4 py-2 rounded-lg control-btn">Catat</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-container hidden">
        <div class="modal-content max-w-sm glass-container">
            <div class="modal-header">
                <h3 class="text-xl font-semibold">Konfirmasi</h3>
                <button id="close-confirmation-modal-btn" class="close-modal-btn">&times;</button>
            </div>
            <div class="p-6">
                <p id="confirmation-message" class="text-gray-300"></p>
            </div>
            <div class="modal-footer">
                <button id="cancel-confirmation-btn" class="cancel-modal-btn">Batal</button>
                <button id="confirm-action-btn" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Hapus</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="w-16 h-16 border-4 border-t-cyan-400 border-gray-600 rounded-full animate-spin"></div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-lg flex items-center gap-3 transform translate-x-[150%] opacity-0 z-[99]">
        <span id="toast-icon"></span>
        <span id="toast-message"></span>
    </div>

    <input type="file" id="import-prices-file-input" class="hidden" accept=".xlsx, .xls">
    <input type="file" id="import-allocation-file-input" class="hidden" accept=".xlsx, .xls">

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SECTION: Constants & Global State ---
        const DEFAULT_ITEMS = [
            { id: 'item-khenaizi', code: 'KHZ', name: 'DC Khenaizi 250g', unit: 'Pcs', harga: 0 },
            { id: 'item-khalas', code: 'RGD', name: 'DC Khalas Rigid 250g', unit: 'Pcs', harga: 0 }
        ];
        const productNames = ["DC Khenaizi 250g", "DC Khalas Rigid 250g"];
        const WAREHOUSES = [
            'Gudang Jakarta 136', 'Gudang Jakarta 156', 'Gudang Karawang', 
            'Gudang Semarang', 'Gudang Surabaya', 'Gudang Medan', 'Gudang Luar'
        ];
        const GUDANG_REGIONS = ['Gd Jakarta', 'Gd Kerawang', 'Gd Semarang', 'Gd Surabaya', 'Gd Medan'];
        const CUSTOMERS = [
            'DC JAKARTA', 'DC TANGERANG', 'DC TANGERANG 2', 'DC PURWAKARTA', 'DC BEKASI', 'DC PARUNG', 'DC BOGOR', 'DC BOGOR 2', 'DC JAKARTA 2', 'DC LEBAK', 'DC BANDUNG', 'DC CIREBON', 'DC YOGYAKARTA', 'DC SEMARANG 2', 'DC KLATEN', 'DC SEMARANG', 'DC JEMBER', 'DC MALANG', 'DC JOMBANG', 'DC JOMBANG 2', 'DC SIDOARJO', 'DC GRESIK', 'DC SAMARINDA', 'DC BANJARMASIN', 'DC BULUNGAN ADMINISTRATIF', 'DC TARAKAN ADMINISTRATIF', 'DC PONTIANAK', 'DC MAKASSAR', 'DC KENDARI ADMINISTRATIF', 'DC PALOPO', 'DC SELAYAR ADMINISTRATIF', 'DC BAU BAU ADMINISTRATIF', 'DC MANADO', 'DC BANDAR LAMPUNG', 'DC MEDAN', 'DC PALEMBANG', 'DC PEKANBARU', 'DC BATAM', 'DC JAMBI ADMINISTRATIF', 'DC BENGKULU', 'DC NIAS ADMINISTRATIF', 'DC TJ. PINANG ADMINISTRATIF', 'DC STABAT', 'DC ACEH', 'DC BANGKA', 'DC BALI', 'DC LOMBOK', 'DC AMBON ADMINISTRATIF', 'DC TERNATE', 'DC BIMA ADMINISTRATIF', 'DC SORONG', 'DC KUPANG', 'DCI ADMINISTRASI JAYAPURA (JAP)', 'DC ENDE ADMINISTRATIF', 'DC MANOKWARI', 'DC WAINGAPU ADMINISTRASI (SBA)'
        ];
        const LOW_STOCK_THRESHOLD = 20;

        let stockData = [];       // Item Master Data
        let stockEntries = [];    // Transactional data for stock coming in
        let salesData = [];
        let forecastData = {};
        let users = [];
        let currentUser = null;
        let dcToGdMap = {};       
        let gudangAllocations = {}; 
        let hargaPelanggan = {}; // State for customer-specific prices
        let currentSort = { key: 'name', order: 'asc' }; // For table sorting
        let totalInChart = null;
        let totalSoldChart = null;


        // --- SECTION: DOM Element Caching ---
        const loginOverlay = document.getElementById('login-overlay');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const mainApp = document.getElementById('main-app');
        const logoutBtn = document.getElementById('logout-btn');
        
        const themeToggle = document.getElementById('theme-toggle');
        const searchInput = document.getElementById('search-input');
        
        const dashboardView = document.getElementById('dashboard-view');
        const stockView = document.getElementById('stock-view');
        const salesView = document.getElementById('sales-view');
        const forecastView = document.getElementById('forecast-view');
        const allocationView = document.getElementById('allocation-view');
        const usersView = document.getElementById('users-view');
        const pricesView = document.getElementById('prices-view');
        const tabButtons = document.querySelectorAll('.tab-btn');
        
        const dashboardContainer = document.getElementById('dashboard-container');
        const stockTableBody = document.getElementById('stock-table-body');
        const salesTableBody = document.getElementById('sales-table-body');
        const forecastTableBody = document.getElementById('forecast-table-body');
        const allocationTableBody = document.getElementById('allocation-table-body');
        const noStockDataMsg = document.getElementById('no-stock-data-message');
        const noSalesDataMsg = document.getElementById('no-sales-data-message');
        const stockEntryHistoryTableBody = document.getElementById('stock-entry-history-table-body');
        const noStockEntryMsg = document.getElementById('no-stock-entry-message');
        const salesSummaryContainer = document.getElementById('sales-summary-container');

        const addStockBtn = document.getElementById('add-stock-btn');
        const recordSaleBtn = document.getElementById('record-sale-btn');
        const saveForecastBtn = document.getElementById('save-forecast-btn');
        const saveAllocationBtn = document.getElementById('save-allocation-btn');
        const printSalesBtn = document.getElementById('print-sales-btn');
        const printStockBtn = document.getElementById('print-stock-btn');
        const exportStockBtn = document.getElementById('export-stock-btn');
        
        const importSalesBtn = document.getElementById('import-sales-btn');
        const exportSalesBtn = document.getElementById('export-sales-btn');
        const importSalesFileInput = document.getElementById('import-sales-file-input');
        const importForecastBtn = document.getElementById('import-forecast-btn');
        const exportForecastBtn = document.getElementById('export-forecast-btn');
        const importForecastFileInput = document.getElementById('import-forecast-file-input');
        const importStockBtn = document.getElementById('import-stock-btn');
        const importStockFileInput = document.getElementById('import-stock-file-input');
        const exportAllocationBtn = document.getElementById('export-allocation-btn');
        const importAllocationBtn = document.getElementById('import-allocation-btn');
        const importAllocationFileInput = document.getElementById('import-allocation-file-input');

        const addUserForm = document.getElementById('add-user-form');
        const usersTableBody = document.getElementById('users-table-body');
        const customerPricesTableHead = document.getElementById('customer-prices-table-head');
        const customerPricesTableBody = document.getElementById('customer-prices-table-body');
        const saveCustomerPricesBtn = document.getElementById('save-customer-prices-btn');
        const importPricesBtn = document.getElementById('import-prices-btn');
        const exportPricesBtn = document.getElementById('export-prices-btn');
        const importPricesFileInput = document.getElementById('import-prices-file-input');

        const itemModal = document.getElementById('item-modal');
        const itemForm = document.getElementById('item-form');
        const itemModalTitle = document.getElementById('item-modal-title');
        const itemDateInput = document.getElementById('item-date');
        const itemCodeSelect = document.getElementById('item-code');
        const itemNameSelect = document.getElementById('item-name');
        const warehouseStockInputsContainer = document.getElementById('warehouse-stock-inputs');
        
        const saleModal = document.getElementById('sale-modal');
        const saleForm = document.getElementById('sale-form');
        const saleCustomerNameSelect = document.getElementById('sale-customer-name');
        const saleDateInput = document.getElementById('sale-date');
        const salePoNumberInput = document.getElementById('sale-po-number');
        const saleSjNumberInput = document.getElementById('sale-sj-number');
        const saleKeteranganInput = document.getElementById('sale-keterangan');
        const saleWarehouseSelect = document.getElementById('sale-warehouse');
        const saleItemIdSelect = document.getElementById('sale-item-id');
        const saleQuantityInput = document.getElementById('sale-quantity');
        const availableStockInfo = document.getElementById('available-stock-info');
        const saleItemPriceDisplay = document.getElementById('sale-item-price-display');
        const saleTotalPriceDisplay = document.getElementById('sale-total-price-display');

        const toastEl = document.getElementById('toast');
        const toastMessageEl = document.getElementById('toast-message');
        const toastIconEl = document.getElementById('toast-icon');
        const loadingOverlay = document.getElementById('loading-overlay');
        const confirmationModal = document.getElementById('confirmation-modal');

        // --- SECTION: Helper & Utility Functions ---

        const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount || 0);
        const formatNumber = (num) => new Intl.NumberFormat('id-ID').format(num || 0);
        const generateWarehouseInputs = () => {
            warehouseStockInputsContainer.innerHTML = '';
            WAREHOUSES.forEach(wh => {
                const div = document.createElement('div');
                div.innerHTML = `<label class="modal-label text-xs">${wh.replace('Gudang ', '')}</label><input type="number" min="0" value="0" placeholder="Jumlah Masuk" data-warehouse="${wh}" class="modal-input w-full text-sm p-1" />`;
                warehouseStockInputsContainer.appendChild(div);
            });
        };
        const populateWarehouseSelects = () => {
            saleWarehouseSelect.innerHTML = '<option value="">-- Pilih Gudang --</option>';
            WAREHOUSES.forEach(wh => { saleWarehouseSelect.innerHTML += `<option value="${wh}">${wh}</option>`; });
        };
        const populateCustomerSelect = () => {
            saleCustomerNameSelect.innerHTML = '';
            CUSTOMERS.forEach(c => { saleCustomerNameSelect.innerHTML += `<option value="${c}">${c}</option>`; });
        };
        const showLoader = () => loadingOverlay.classList.remove('hidden');
        const hideLoader = () => loadingOverlay.classList.add('hidden');
        const showToast = (message, isError = false) => {
            toastMessageEl.textContent = message;
            if (isError) {
                toastEl.className = 'fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg flex items-center gap-3 transform transition-transform duration-300 bg-red-500';
                toastIconEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;
            } else {
                toastEl.className = 'fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg flex items-center gap-3 transform transition-transform duration-300 bg-green-600';
                toastIconEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
            }
            toastEl.classList.remove('translate-x-[150%]', 'opacity-0');
            setTimeout(() => toastEl.classList.add('translate-x-[150%]', 'opacity-0'), 3000);
        };
        const showConfirmationModal = (message, onConfirm) => {
            document.getElementById('confirmation-message').textContent = message;
            const confirmBtn = document.getElementById('confirm-action-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                confirmationModal.classList.add('hidden');
            });
            confirmationModal.classList.remove('hidden');
        };

        // --- SECTION: Data Persistence (localStorage) ---
        
        const saveData = () => {
            localStorage.setItem('stockData-v3', JSON.stringify(stockData));
            localStorage.setItem('stockEntries-v3', JSON.stringify(stockEntries));
            localStorage.setItem('salesData-v3', JSON.stringify(salesData));
            localStorage.setItem('forecastData-v3', JSON.stringify(forecastData));
            localStorage.setItem('users-v3', JSON.stringify(users));
            localStorage.setItem('dcToGdMap-v3', JSON.stringify(dcToGdMap));
            localStorage.setItem('gudangAllocations-v3', JSON.stringify(gudangAllocations));
            localStorage.setItem('hargaPelanggan-v2', JSON.stringify(hargaPelanggan));
        };

        const loadData = () => {
            stockData = JSON.parse(localStorage.getItem('stockData-v3')) || [...DEFAULT_ITEMS];
            // Ensure default items always exist
            DEFAULT_ITEMS.forEach(defaultItem => {
                if (!stockData.some(item => item.id === defaultItem.id)) {
                    stockData.push(defaultItem);
                }
            });

            stockEntries = JSON.parse(localStorage.getItem('stockEntries-v3')) || [];
            salesData = (JSON.parse(localStorage.getItem('salesData-v3')) || []).map(sale => ({ ...sale, nomorPO: sale.nomorPO || '', nomorSJ: sale.nomorSJ || '', keterangan: sale.keterangan || '' }));
            const loadedForecast = JSON.parse(localStorage.getItem('forecastData-v3')) || {};
            
            CUSTOMERS.forEach(c => {
                if (!loadedForecast[c]) loadedForecast[c] = {};
                productNames.forEach(item => { if (loadedForecast[c][item] === undefined) loadedForecast[c][item] = 0; });
            });
            forecastData = loadedForecast;

            users = JSON.parse(localStorage.getItem('users-v3')) || [];
            if (!users.some(user => user.username === 'admin')) {
                users.unshift({ id: crypto.randomUUID(), username: 'admin', password: 'admin123', role: 'admin' });
            }

            dcToGdMap = JSON.parse(localStorage.getItem('dcToGdMap-v3')) || {};
            gudangAllocations = JSON.parse(localStorage.getItem('gudangAllocations-v3')) || {};
            hargaPelanggan = JSON.parse(localStorage.getItem('hargaPelanggan-v2')) || {};

            saveData(); 
        };

        // --- SECTION: Core Business Logic ---

        const calculateStock = (itemCode, warehouse = null) => {
            if (!stockData.some(i => i.code === itemCode)) return { totalIn: 0, totalSold: 0, finalStock: 0 };
            const totalIn = stockEntries.filter(e => e.itemCode === itemCode && (!warehouse || e.warehouse === warehouse)).reduce((sum, e) => sum + e.quantity, 0);
            const itemIdsWithSameCode = stockData.filter(i => i.code === itemCode).map(i => i.id);
            const totalSold = salesData.filter(s => itemIdsWithSameCode.includes(s.itemId) && (!warehouse || s.gudang === warehouse)).reduce((sum, s) => sum + s.quantity, 0);
            return { totalIn, totalSold, finalStock: totalIn - totalSold };
        };

        // --- SECTION: Rendering Functions ---

        const renderStockTable = (filter = '') => {
            stockTableBody.innerHTML = '';
            const lowercasedFilter = filter.toLowerCase();
            let filteredData = stockData.filter(item => (item.name && item.name.toLowerCase().includes(lowercasedFilter)) || (item.code && item.code.toLowerCase().includes(lowercasedFilter)));

            const dataForSorting = filteredData.map(item => ({ ...item, ...calculateStock(item.code) }));
            dataForSorting.sort((a, b) => {
                const aVal = a[currentSort.key], bVal = b[currentSort.key];
                const order = currentSort.order === 'asc' ? 1 : -1;
                return typeof aVal === 'string' ? aVal.localeCompare(bVal) * order : (aVal - bVal) * order;
            });
            filteredData = dataForSorting;
            noStockDataMsg.classList.toggle('hidden', filteredData.length > 0);
            
            filteredData.forEach((item, index) => {
                const { totalIn, totalSold, finalStock } = item;
                const isLowStock = finalStock <= LOW_STOCK_THRESHOLD && finalStock > 0;
                const isOutOfStock = finalStock <= 0;
                let rowClass = `border-b border-slate-700 hover:bg-slate-800/50 ${isLowStock ? 'low-stock-warning' : ''} ${isOutOfStock ? 'opacity-60' : ''}`;

                const row = document.createElement('tr');
                row.className = rowClass;
                row.innerHTML = `
                    <td class="px-4 py-3">${index + 1}</td>
                    <td class="px-4 py-3 font-medium text-white">${item.code}</td>
                    <th scope="row" class="px-6 py-4 font-medium text-white whitespace-nowrap">${item.name}</th>
                    <td class="px-4 py-3 text-center">${formatNumber(totalIn)}</td>
                    <td class="px-4 py-3 text-center">${formatNumber(totalSold)}</td>
                    <td class="px-4 py-3 text-center font-bold text-cyan-400">
                        <div class="flex items-center justify-center gap-2">
                           ${isLowStock ? `<svg class="w-4 h-4 text-amber-400" title="Stok Menipis" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>` : ''}
                           ${isOutOfStock ? `<svg class="w-4 h-4 text-red-500" title="Stok Habis" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 11c-.55 0-1-.45-1-1V8c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1zm0 4c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg>` : ''}
                           ${formatNumber(finalStock)}
                        </div>
                    </td>
                    <td class="px-4 py-3">${item.unit}</td>
                </tr>`;
                stockTableBody.appendChild(row);
            });
        };

        const renderStockEntryHistory = () => {
            stockEntryHistoryTableBody.innerHTML = '';
            noStockEntryMsg.classList.toggle('hidden', stockEntries.length > 0);
            [...stockEntries].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((entry, index) => {
                const item = stockData.find(i => i.code === entry.itemCode);
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-700';
                row.innerHTML = `
                    <td class="px-4 py-3">${index + 1}</td>
                    <td class="px-6 py-4">${new Date(entry.date).toLocaleDateString('id-ID', {day: '2-digit', month: 'short', year: 'numeric'})}</td>
                    <td class="px-4 py-3">${entry.itemCode}</td>
                    <th class="px-6 py-4 font-medium text-white whitespace-nowrap">${item ? item.name : 'N/A'}</th>
                    <td class="px-6 py-4">${entry.warehouse}</td>
                    <td class="px-4 py-3 text-center">${formatNumber(entry.quantity)}</td>
                    <td class="px-4 py-3 text-center no-print admin-only">
                        <div class="flex justify-center items-center gap-4">
                            <button class="edit-stock-entry-btn text-cyan-400 hover:text-cyan-300" data-id="${entry.id}" title="Edit Entri">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button class="delete-stock-entry-btn text-red-500 hover:text-red-400" data-id="${entry.id}" title="Hapus Entri">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                        </div>
                    </td>
                </tr>`;
                stockEntryHistoryTableBody.appendChild(row);
            });
        };

        const renderSalesTable = () => {
            salesTableBody.innerHTML = '';
            noSalesDataMsg.classList.toggle('hidden', salesData.length > 0);
            [...salesData].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((sale, index) => {
                const item = stockData.find(i => i.id === sale.itemId);
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-700 hover:bg-slate-800/50';
                row.innerHTML = `<td class="px-4 py-3">${index + 1}</td><td class="px-6 py-4">${new Date(sale.date).toLocaleDateString('id-ID', {day: '2-digit', month: 'short', year: 'numeric'})}</td><td class="px-6 py-4">${sale.nomorPO || ''}</td><td class="px-6 py-4">${sale.nomorSJ || ''}</td><td class="px-6 py-4">${sale.namaPelanggan || ''}</td><td class="px-6 py-4">${sale.gudang || ''}</td><td class="px-4 py-3 font-medium text-white">${item ? item.code : 'N/A'}</td><th scope="row" class="px-6 py-4 font-medium text-white whitespace-nowrap">${item ? item.name : 'Barang Dihapus'}</th><td class="px-6 py-4">${sale.keterangan || ''}</td><td class="px-4 py-3 text-right">${formatCurrency(sale.hargaSatuan)}</td><td class="px-4 py-3 text-center">${formatNumber(sale.quantity)}</td><td class="px-4 py-3 text-right font-semibold text-white">${formatCurrency(sale.totalHarga)}</td><td class="px-4 py-3 no-print admin-only"><button class="delete-sale-btn text-red-500 hover:text-red-400" data-id="${sale.id}" title="Hapus Pengiriman"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></button></td>`;
                salesTableBody.appendChild(row);
            });
        };

        const renderSalesSummary = () => {
            const totalRevenue = salesData.reduce((sum, sale) => sum + sale.totalHarga, 0);
            const totalItemsSold = salesData.reduce((sum, sale) => sum + sale.quantity, 0);
            const totalTransactions = salesData.length;
            const topProduct = salesData.length > 0 ? Object.entries(salesData.reduce((acc, sale) => { const item = stockData.find(i => i.id === sale.itemId); if(item) acc[item.name] = (acc[item.name] || 0) + sale.quantity; return acc; }, {})).sort((a, b) => b[1] - a[1])[0][0] : 'N/A';
            salesSummaryContainer.innerHTML = `<div class="glass-container p-4 rounded-lg"><h4 class="text-sm font-medium text-gray-400">Total Pendapatan</h4><p class="text-2xl font-bold text-white mt-1">${formatCurrency(totalRevenue)}</p></div><div class="glass-container p-4 rounded-lg"><h4 class="text-sm font-medium text-gray-400">Total Barang Terkirim</h4><p class="text-2xl font-bold text-white mt-1">${formatNumber(totalItemsSold)}</p></div><div class="glass-container p-4 rounded-lg"><h4 class="text-sm font-medium text-gray-400">Jumlah Transaksi</h4><p class="text-2xl font-bold text-white mt-1">${formatNumber(totalTransactions)}</p></div><div class="glass-container p-4 rounded-lg"><h4 class="text-sm font-medium text-gray-400">Produk Terlaris</h4><p class="text-2xl font-bold text-white mt-1 truncate">${topProduct}</p></div>`;
        };
        
        const renderForecastTable = () => {
            forecastTableBody.innerHTML = '';
            CUSTOMERS.forEach(customer => {
                let rowHTML = `<td class="px-6 py-4 font-medium text-white whitespace-nowrap">${customer}</td>`;
                productNames.forEach(itemName => {
                    const item = stockData.find(i => i.name === itemName);
                    const forecastAwal = forecastData[customer]?.[itemName] || 0;
                    const terkirim = salesData.filter(sale => sale.namaPelanggan === customer && item && sale.itemId === item.id).reduce((sum, sale) => sum + sale.quantity, 0);
                    const sisa = forecastAwal - terkirim;
                    const pencapaian = forecastAwal > 0 ? (terkirim / forecastAwal) * 100 : 0;
                    rowHTML += `<td class="px-2 py-2 border-l border-slate-700"><select data-customer="${customer}" data-item="${itemName}" class="gudang-select modal-input w-full p-1 text-sm"><option value="">-- Pilih --</option>${GUDANG_REGIONS.map(gd => `<option value="${gd}" ${dcToGdMap[customer]?.[itemName] === gd ? 'selected' : ''}>${gd}</option>`).join('')}</select></td><td class="px-2 py-2 text-center"><input type="number" value="${forecastAwal}" min="0" data-customer="${customer}" data-item="${itemName}" class="modal-input w-24 p-1 text-center"></td><td class="px-2 py-2 text-center">${formatNumber(terkirim)}</td><td class="px-2 py-2 text-center font-semibold ${sisa < 0 ? 'text-red-500' : 'text-green-400'}">${formatNumber(sisa)}</td><td class="px-2 py-2 border-r border-slate-700" style="min-width: 150px;"><div class="flex items-center gap-2"><div class="w-full bg-slate-700 rounded-full h-2.5"><div class="bg-cyan-400 h-2.5 rounded-full" style="width: ${Math.min(pencapaian, 100)}%"></div></div><span class="text-xs font-medium">${pencapaian.toFixed(1)}%</span></div></td>`;
                });
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-700';
                row.innerHTML = rowHTML;
                forecastTableBody.appendChild(row);
            });
        };

        const renderGudangSummaryTable = () => {
            const summaryTable = document.getElementById('gudang-summary-table');
            summaryTable.innerHTML = ''; 
            let headerHTML = `<thead class="text-xs uppercase bg-slate-900/50 text-gray-300"><tr><th scope="col" rowspan="2" class="px-6 py-3 align-bottom">Wilayah Gudang</th>`;
            productNames.forEach(itemName => { headerHTML += `<th scope="col" colspan="3" class="px-6 py-3 text-center border-b border-l border-r border-slate-700">${itemName}</th>`; });
            headerHTML += `</tr><tr>`;
            productNames.forEach(() => { headerHTML += `<th class="px-2 py-2 text-center border-l border-slate-700">Total Forecast</th><th class="px-2 py-2 text-center">Total Terkirim</th><th class="px-2 py-2 text-center border-r border-slate-700">Total Sisa</th>`; });
            headerHTML += `</tr></thead>`;
            let bodyHTML = '<tbody>';
            GUDANG_REGIONS.forEach(gd => {
                bodyHTML += `<tr class="border-b border-slate-700"><td class="px-6 py-4 font-medium text-white whitespace-nowrap">${gd}</td>`;
                productNames.forEach(itemName => {
                    let totalForecast = 0, totalTerkirim = 0;
                    const item = stockData.find(i => i.name === itemName);
                    for(const customer in dcToGdMap) {
                        if(dcToGdMap[customer]?.[itemName] === gd) {
                            const forecastAwal = forecastData[customer]?.[itemName] || 0;
                            const terkirim = salesData.filter(sale => sale.namaPelanggan === customer && item && sale.itemId === item.id).reduce((sum, sale) => sum + sale.quantity, 0);
                            totalForecast += forecastAwal;
                            totalTerkirim += terkirim;
                        }
                    }
                    const totalSisa = totalForecast - totalTerkirim;
                    bodyHTML += `<td class="px-2 py-2 text-center font-semibold">${formatNumber(totalForecast)}</td><td class="px-2 py-2 text-center font-semibold">${formatNumber(totalTerkirim)}</td><td class="px-2 py-2 text-center font-semibold ${totalSisa < 0 ? 'text-red-500' : 'text-green-400'}">${formatNumber(totalSisa)}</td>`;
                });
                bodyHTML += `</tr>`;
            });
            bodyHTML += '</tbody>';
            summaryTable.innerHTML = headerHTML + bodyHTML;
        };

        const renderAllocationTable = () => {
            allocationTableBody.innerHTML = '';
            GUDANG_REGIONS.forEach(gd => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-700';
                let rowHTML = `<td class="px-6 py-4 font-medium text-white whitespace-nowrap">${gd}</td>`;
                productNames.forEach(itemName => {
                    let totalForecast = 0;
                    for(const customer in dcToGdMap) { if(dcToGdMap[customer]?.[itemName] === gd) totalForecast += forecastData[customer]?.[itemName] || 0; }
                    const allocation = gudangAllocations[gd]?.[itemName] || 0;
                    rowHTML += `<td class="px-6 py-4 text-center font-bold text-cyan-400">${formatNumber(totalForecast)}</td><td class="px-6 py-4"><input type="number" min="0" class="modal-input w-full md:w-1/2 mx-auto text-center" data-gudang="${gd}" data-item="${itemName}" value="${allocation}"></td>`;
                });
                row.innerHTML = rowHTML;
                allocationTableBody.appendChild(row);
            });
        };
        
        const renderDashboard = () => {
            dashboardContainer.innerHTML = '';
            productNames.forEach(itemName => {
                const card = document.createElement('div');
                card.className = 'glass-container p-4 rounded-lg';
                const item = stockData.find(i => i.name === itemName);
                if (!item) { card.innerHTML = `<h3 class="text-lg font-semibold mb-2">${itemName}</h3><p class="text-gray-400">Data barang belum ada.</p>`; dashboardContainer.appendChild(card); return; }
                let warehouseStocks = [], totalOverallIn = 0, totalOverallSent = 0, totalOverallStock = 0;
                WAREHOUSES.forEach(wh => {
                    const { totalIn, totalSold, finalStock } = calculateStock(item.code, wh);
                    totalOverallIn += totalIn; totalOverallSent += totalSold; totalOverallStock += finalStock;
                    warehouseStocks.push({ name: wh.replace('Gudang ', ''), stock: finalStock });
                });
                const maxStock = Math.max(...warehouseStocks.map(ws => ws.stock), 1);
                let chartHTML = warehouseStocks.map(ws => `<div class="flex items-center gap-2 group"><div class="w-24 text-right text-xs truncate" title="${ws.name}">${ws.name}</div><div class="flex-1 bg-slate-700 rounded-full h-4"><div class="bg-cyan-500 h-4 rounded-full text-white text-xs flex items-center justify-end pr-2" style="width: ${Math.min(100, (ws.stock / maxStock) * 100)}%" title="Stok: ${formatNumber(ws.stock)}"><span class="opacity-0 group-hover:opacity-100 transition-opacity">${formatNumber(ws.stock)}</span></div></div></div>`).join('');
                card.innerHTML = `<h3 class="text-lg font-semibold mb-4">${itemName}</h3><div class="space-y-2 mb-4">${chartHTML}</div><div class="border-t-2 border-slate-700 mt-4 pt-2 grid grid-cols-3 gap-2 text-center text-sm"><div><p class="text-gray-400">Total Masuk</p><p class="font-bold text-cyan-400 text-lg">${formatNumber(totalOverallIn)}</p></div><div><p class="text-gray-400">Total Terkirim</p><p class="font-bold text-pink-400 text-lg">${formatNumber(totalOverallSent)}</p></div><div><p class="text-gray-400">Stok Akhir</p><p class="font-bold text-green-400 text-lg">${formatNumber(totalOverallStock)}</p></div></div>`;
                dashboardContainer.appendChild(card);
            });

             // --- Chart Rendering Logic ---
            const khenaiziData = calculateStock('KHZ');
            const khalasData = calculateStock('RGD');
            
            const totalInValues = [khenaiziData.totalIn, khalasData.totalIn];
            const totalSoldValues = [khenaiziData.totalSold, khalasData.totalSold];
            const totalSoldSum = totalSoldValues.reduce((a, b) => a + b, 0);

            const chartLabels = ['DC Khenaizi 250g', 'DC Khalas Rigid 250g'];
            const chartColors = ['#00f6ff', '#ff00ff']; // Cyan, Pink

            // Destroy existing charts if they exist
            if (totalInChart) {
                totalInChart.destroy();
            }
            if (totalSoldChart) {
                totalSoldChart.destroy();
            }

            // 1. Total In Chart (Pie)
            const totalInCtx = document.getElementById('total-in-chart').getContext('2d');
            totalInChart = new Chart(totalInCtx, {
                type: 'pie',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Total Masuk',
                        data: totalInValues,
                        backgroundColor: chartColors,
                        borderColor: '#1e293b', // slate-800
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#cbd5e1' // slate-300
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatNumber(context.parsed) + ' Pcs';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // 2. Total Sold Chart (Pie - Percentage)
            const totalSoldCtx = document.getElementById('total-sold-chart').getContext('2d');
            totalSoldChart = new Chart(totalSoldCtx, {
                type: 'pie',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Total Kiriman',
                        data: totalSoldValues,
                        backgroundColor: chartColors,
                        borderColor: '#1e293b',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#cbd5e1'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percentage = totalSoldSum > 0 ? ((value / totalSoldSum) * 100).toFixed(1) : 0;
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += `${formatNumber(value)} Pcs (${percentage}%)`;
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        };

        const renderUsersTable = () => {
            usersTableBody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-700';
                row.innerHTML = `<td class="px-6 py-4">${user.username}</td><td class="px-6 py-4 capitalize">${user.role}</td><td class="px-6 py-4">${(currentUser && currentUser.username !== user.username) ? `<button class="delete-user-btn text-red-500 hover:text-red-400" data-id="${user.id}" title="Hapus Pengguna">&times; Hapus</button>` : ''}</td>`;
                usersTableBody.appendChild(row);
            });
        };

        const renderCustomerPricesTable = () => {
            customerPricesTableHead.innerHTML = `<tr><th class="px-6 py-3">Pelanggan (DC)</th><th class="px-6 py-3 text-center">DC Khenaizi 250g</th><th class="px-6 py-3 text-center">DC Khalas Rigid 250g</th></tr>`;
            customerPricesTableBody.innerHTML = '';
            CUSTOMERS.forEach(customer => {
                let bodyRow = `<tr class="border-b border-slate-700"><td class="px-6 py-4 font-medium text-white whitespace-nowrap">${customer}</td>`;
                productNames.forEach(item => {
                    const price = hargaPelanggan[customer]?.[item] || 0;
                    bodyRow += `<td class="px-2 py-2"><input type="number" min="0" value="${price}" data-customer="${customer}" data-item="${item}" class="modal-input w-full text-center p-1" placeholder="Rp"></td>`;
                });
                bodyRow += `</tr>`;
                customerPricesTableBody.innerHTML += bodyRow;
            });
        };

        const refreshAll = (filter = '') => {
            renderDashboard(); renderStockTable(filter); renderStockEntryHistory(); renderSalesTable(); renderSalesSummary(); renderForecastTable(); renderUsersTable(); renderGudangSummaryTable(); renderAllocationTable(); renderCustomerPricesTable();
        };

        // --- SECTION: Excel Import/Export ---
        const exportStockToExcel = () => {
            showLoader();
            try {
                const exportData = stockData.map((item, index) => {
                    const { totalIn, totalSold, finalStock } = calculateStock(item.code);
                    return { 'No': index + 1, 'Kode': item.code, 'Nama Barang': item.name, 'Total Masuk': totalIn, 'Total Keluar': totalSold, 'Total Stok Akhir': finalStock, 'Satuan': item.unit, 'Harga Jual (Rp)': item.harga };
                });
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan Stok");
                XLSX.writeFile(workbook, "laporan_stok_gudang.xlsx");
                showToast("Data stok berhasil diekspor!");
            } catch(e) {
                showToast("Gagal mengekspor data stok.", true);
                console.error(e);
            } finally {
                hideLoader();
            }
        };

        const importStockFromExcel = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            showLoader();
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    let stockUpdates = 0;
                    const today = new Date().toISOString().split('T')[0];
                    const newEntries = [];

                    jsonData.forEach(row => {
                        const code = row['Kode']?.toString().trim();
                        // Only process rows with valid, known item codes
                        if (!code || !DEFAULT_ITEMS.some(item => item.code === code)) {
                            return; 
                        }

                        WAREHOUSES.forEach(wh => {
                            const whKey = wh.replace(/\s+/g, ' '); // Handle potential space differences in Excel headers
                            const qty = parseInt(row[whKey], 10);
                            if (!isNaN(qty) && qty > 0) {
                                newEntries.push({
                                    id: crypto.randomUUID(),
                                    date: today,
                                    itemCode: code,
                                    warehouse: wh,
                                    quantity: qty
                                });
                                stockUpdates++;
                            }
                        });
                    });
                    
                    if (stockUpdates > 0) {
                        stockEntries.push(...newEntries);
                        saveData();
                        refreshAll();
                        showToast(`${stockUpdates} entri stok berhasil diimpor.`);
                    } else {
                        showToast("Tidak ada data stok valid untuk diimpor.", true);
                    }

                } catch (error) {
                    console.error("Import Stock Error:", error);
                    showToast("Gagal mengimpor file. Pastikan format kolom benar (Kode, dan nama-nama Gudang).", true);
                } finally {
                    importStockFileInput.value = '';
                    hideLoader();
                }
            };
            reader.readAsArrayBuffer(file);
        };
        
        const exportSalesToExcel = () => {
             showLoader();
            try {
                const exportData = salesData.map((sale, index) => {
                    const item = stockData.find(i => i.id === sale.itemId);
                    return {
                        'No': index + 1, 'Tanggal': new Date(sale.date).toLocaleDateString('id-ID'), 'No. PO': sale.nomorPO, 'No. SJ': sale.nomorSJ, 'Pelanggan': sale.namaPelanggan, 'Gudang': sale.gudang, 'Kode Barang': item ? item.code : 'N/A', 'Nama Barang': item ? item.name : 'Dihapus', 'Keterangan': sale.keterangan, 'Harga Satuan': sale.hargaSatuan, 'Qty': sale.quantity, 'Total Harga': sale.totalHarga
                    };
                });
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan Pengiriman");
                XLSX.writeFile(workbook, "laporan_pengiriman.xlsx");
                showToast("Data pengiriman berhasil diekspor!");
            } catch(e) {
                showToast("Gagal mengekspor data pengiriman.", true);
                console.error(e);
            } finally {
                hideLoader();
            }
        };
        
        const importSalesFromExcel = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            showLoader();
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { raw: false });

                    let salesAdded = 0;
                    let errors = [];
                    const newSales = [];

                    jsonData.forEach((row, index) => {
                        const itemCode = row['Kode Barang']?.toString().trim();
                        const warehouse = row['Gudang']?.toString().trim();
                        const quantity = parseInt(row['Qty'], 10);
                        const customer = row['Pelanggan']?.toString().trim();
                        const item = DEFAULT_ITEMS.find(i => i.code === itemCode);

                        if (!item || !WAREHOUSES.includes(warehouse) || !CUSTOMERS.includes(customer) || isNaN(quantity) || quantity <= 0) {
                            errors.push(`Baris ${index + 2} tidak valid: Data barang, gudang, pelanggan, atau qty salah.`);
                            return;
                        }

                        const { finalStock } = calculateStock(item.code, warehouse);
                        if (quantity > finalStock) {
                            errors.push(`Baris ${index + 2}: Stok tidak cukup untuk ${item.name} di ${warehouse}. Butuh: ${quantity}, Tersedia: ${finalStock}.`);
                            return;
                        }
                        
                        let saleDate = new Date(); // Default to today
                        if (row['Tanggal']) {
                            const excelDate = Number(row['Tanggal']);
                            if (!isNaN(excelDate) && excelDate > 1) {
                                saleDate = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
                            } else if (!isNaN(new Date(row['Tanggal']))) {
                                saleDate = new Date(row['Tanggal']);
                            }
                        }

                        const excelUnitPrice = parseFloat(row['Harga Satuan']);
                        let unitPriceToUse;

                        if (!isNaN(excelUnitPrice) && excelUnitPrice >= 0) {
                            unitPriceToUse = excelUnitPrice;
                        } else {
                            const customerPrice = hargaPelanggan[customer]?.[item.name];
                            unitPriceToUse = (customerPrice !== undefined && customerPrice >= 0) ? customerPrice : (item.harga || 0);
                        }
                        
                        const totalPrice = unitPriceToUse * quantity;

                        newSales.push({
                            id: crypto.randomUUID(),
                            itemId: item.id,
                            quantity: quantity,
                            gudang: warehouse,
                            hargaSatuan: unitPriceToUse,
                            totalHarga: totalPrice,
                            date: saleDate.toISOString(),
                            namaPelanggan: customer,
                            nomorPO: row['No. PO']?.toString().trim() || '',
                            nomorSJ: row['No. SJ']?.toString().trim() || '',
                            keterangan: row['Keterangan']?.toString().trim() || ''
                        });
                        salesAdded++;
                    });
                    
                    if (salesAdded > 0) {
                        salesData.push(...newSales);
                        saveData();
                        refreshAll();
                        showToast(`${salesAdded} data pengiriman berhasil diimpor.`);
                    } else {
                        showToast("Tidak ada data pengiriman valid untuk diimpor.", true);
                    }
                    if (errors.length > 0) {
                        console.error("Import Sales Errors:", errors);
                        showToast(`Selesai dengan ${errors.length} error. Cek konsol untuk detail.`, true);
                    }

                } catch (error) {
                    console.error("Import Sales Error:", error);
                    showToast("Gagal mengimpor file. Pastikan format kolom benar.", true);
                } finally {
                    importSalesFileInput.value = '';
                    hideLoader();
                }
            };
            reader.readAsArrayBuffer(file);
        };

        const exportForecastToExcel = () => {
            const exportData = [];
            CUSTOMERS.forEach(customer => {
                const rowData = { 'Lokasi (DC)': customer };
                productNames.forEach(itemName => {
                    const item = stockData.find(i => i.name === itemName);
                    const forecast = forecastData[customer]?.[itemName] || 0;
                    const sent = item ? salesData.filter(s => s.namaPelanggan === customer && s.itemId === item.id).reduce((sum, s) => sum + s.quantity, 0) : 0;
                    const remainder = forecast - sent;
                    const achievement = forecast > 0 ? `${((sent / forecast) * 100).toFixed(1)}%` : '0.0%';
                    rowData[`Wilayah Gudang ${itemName}`] = dcToGdMap[customer]?.[itemName] || '';
                    rowData[`Forecast ${itemName}`] = forecast;
                    rowData[`Terkirim ${itemName}`] = sent;
                    rowData[`Sisa ${itemName}`] = remainder;
                    rowData[`Pencapaian ${itemName}`] = achievement;
                });
                exportData.push(rowData);
            });
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Data Forecast");
            XLSX.writeFile(workbook, "laporan_forecast.xlsx");
            showToast("Data forecast berhasil diekspor!");
        };

        const importForecastFromExcel = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            showLoader();
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    let updatedCount = 0;
                    let mapUpdates = 0;
                    jsonData.forEach(row => {
                        const customer = row['Lokasi (DC)'];
                        if (customer && CUSTOMERS.includes(customer)) {
                            if (!dcToGdMap[customer]) dcToGdMap[customer] = {};
                            if (!forecastData[customer]) forecastData[customer] = {};

                            const rowKeys = Object.keys(row);

                            productNames.forEach(itemName => {
                                // Find the relevant keys dynamically and flexibly
                                const gudangKey = rowKeys.find(k => k.startsWith('Wilayah Gudang') && k.includes(itemName));
                                const forecastKey = rowKeys.find(k => k.startsWith('Forecast') && k.includes(itemName));

                                if (gudangKey) {
                                    const gudangWilayah = row[gudangKey]?.toString().trim();
                                    if (gudangWilayah && GUDANG_REGIONS.includes(gudangWilayah)) {
                                        if(dcToGdMap[customer][itemName] !== gudangWilayah){
                                            dcToGdMap[customer][itemName] = gudangWilayah;
                                            mapUpdates++;
                                        }
                                    }
                                }
                                
                                if (forecastKey && row[forecastKey] !== undefined && !isNaN(row[forecastKey])) {
                                    forecastData[customer][itemName] = Number(row[forecastKey]);
                                    updatedCount++;
                                }
                            });
                        }
                    });
                    
                    if (updatedCount > 0 || mapUpdates > 0) {
                        saveData();
                        refreshAll();
                        showToast(`${updatedCount} data forecast dan ${mapUpdates} pemetaan gudang berhasil diimpor/diperbarui.`);
                    } else {
                        showToast("Tidak ada data forecast yang valid ditemukan di file.", true);
                    }
                } catch (error) {
                    console.error("Import Forecast Error:", error);
                    showToast("Gagal mengimpor file forecast. Pastikan format benar.", true);
                } finally {
                    importForecastFileInput.value = '';
                    hideLoader();
                }
            };
            reader.readAsArrayBuffer(file);
        };
        
        const exportAllocationToExcel = () => {
            const exportData = [];
            GUDANG_REGIONS.forEach(gd => {
                const rowData = { 'Wilayah Gudang': gd };
                productNames.forEach(itemName => {
                    let totalForecast = 0;
                    for (const customer in dcToGdMap) {
                        if (dcToGdMap[customer]?.[itemName] === gd) {
                            totalForecast += forecastData[customer]?.[itemName] || 0;
                        }
                    }
                    const allocation = gudangAllocations[gd]?.[itemName] || 0;
                    rowData[`Kebutuhan Forecast ${itemName}`] = totalForecast;
                    rowData[`Alokasi Stok Masuk ${itemName}`] = allocation;
                });
                exportData.push(rowData);
            });
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Data Alokasi Gudang");
            XLSX.writeFile(workbook, "laporan_alokasi_gudang.xlsx");
            showToast("Data alokasi gudang berhasil diekspor!");
        };

        const importAllocationFromExcel = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            showLoader();
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    let updatedCount = 0;
                    jsonData.forEach(row => {
                        const gudang = row['Wilayah Gudang']?.toString().trim();
                        if (gudang && GUDANG_REGIONS.includes(gudang)) {
                            if (!gudangAllocations[gudang]) {
                                gudangAllocations[gudang] = {};
                            }
                            
                            productNames.forEach(itemName => {
                                const allocationKey = `Alokasi Stok Masuk ${itemName}`;
                                const allocationValue = row[allocationKey];
                                
                                if (allocationValue !== undefined && !isNaN(allocationValue)) {
                                    gudangAllocations[gudang][itemName] = parseFloat(allocationValue);
                                    updatedCount++;
                                }
                            });
                        }
                    });

                    if (updatedCount > 0) {
                        saveData();
                        refreshAll();
                        showToast(`${updatedCount} data alokasi berhasil diimpor/diperbarui.`);
                    } else {
                        showToast("Tidak ada data alokasi yang valid ditemukan di file.", true);
                    }
                } catch (error) {
                    console.error("Import Allocation Error:", error);
                    showToast("Gagal mengimpor file alokasi. Pastikan format kolom benar.", true);
                } finally {
                    importAllocationFileInput.value = '';
                    hideLoader();
                }
            };
            reader.readAsArrayBuffer(file);
        };
        
        const exportCustomerPricesToExcel = () => {
            const exportData = CUSTOMERS.map(customer => {
                const rowData = { 'Pelanggan (DC)': customer };
                productNames.forEach(item => {
                    rowData[item] = hargaPelanggan[customer]?.[item] || 0;
                });
                return rowData;
            });
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Data Harga Pelanggan");
            XLSX.writeFile(workbook, "laporan_harga_pelanggan.xlsx");
            showToast("Data harga pelanggan berhasil diekspor!");
        };
        
        const importCustomerPricesFromExcel = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            showLoader();
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    let updatedCount = 0;
                    jsonData.forEach(row => {
                        const customer = row['Pelanggan (DC)'];
                        if (customer && CUSTOMERS.includes(customer)) {
                            if (!hargaPelanggan[customer]) {
                                hargaPelanggan[customer] = {};
                            }
                            productNames.forEach(item => {
                                if (row[item] !== undefined && !isNaN(row[item])) {
                                    hargaPelanggan[customer][item] = parseFloat(row[item]);
                                    updatedCount++;
                                }
                            });
                        }
                    });

                    if (updatedCount > 0) {
                        saveData();
                        refreshAll();
                        showToast(`${updatedCount} data harga berhasil diimpor/diperbarui.`);
                    } else {
                        showToast("Tidak ada data harga yang valid ditemukan di file.", true);
                    }
                } catch (error) {
                    console.error("Import Prices Error:", error);
                    showToast("Gagal mengimpor file harga. Pastikan format benar.", true);
                } finally {
                    importPricesFileInput.value = '';
                    hideLoader();
                }
            };
            reader.readAsArrayBuffer(file);
        };


        // --- SECTION: Event Handlers & Logic ---
        
        const applyTheme = (theme) => {
            // Force dark theme
            document.documentElement.classList.add('dark');
        };

        const applyPermissions = () => {
            const isAdmin = currentUser && currentUser.role === 'admin';
            document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin));
        };
        
        const openAddStockModal = () => {
            itemForm.reset();
            itemModalTitle.textContent = 'Tambah Stok Masuk';
            document.getElementById('stock-entry-id').value = ''; 

            itemCodeSelect.disabled = false;
            itemNameSelect.disabled = false;
            
            document.getElementById('item-extra-details-section').classList.add('hidden');
            document.getElementById('warehouse-section').style.display = 'block';

            itemDateInput.valueAsDate = new Date();
            warehouseStockInputsContainer.querySelectorAll('input[data-warehouse]').forEach(input => {
                input.value = 0;
                input.closest('div').style.display = 'block'; 
            });
            itemModal.classList.remove('hidden');
        };
        
        const openEditStockEntryModal = (entryId) => {
            const entry = stockEntries.find(e => e.id === entryId);
            if (!entry) return;

            itemForm.reset();
            itemModalTitle.textContent = 'Edit Pemasukan Stok';
            document.getElementById('stock-entry-id').value = entry.id;

            itemDateInput.value = entry.date.split('T')[0];
            itemCodeSelect.value = entry.itemCode;
            itemCodeSelect.disabled = true;
            itemNameSelect.value = stockData.find(i => i.code === entry.itemCode).name;
            itemNameSelect.disabled = true;
            
            document.getElementById('item-extra-details-section').classList.add('hidden');
            document.getElementById('warehouse-section').style.display = 'block';

            warehouseStockInputsContainer.querySelectorAll('input[data-warehouse]').forEach(input => {
                const parentDiv = input.closest('div');
                if (input.dataset.warehouse === entry.warehouse) {
                    input.value = entry.quantity;
                    parentDiv.style.display = 'block';
                } else {
                    input.value = 0;
                    parentDiv.style.display = 'none';
                }
            });
            
            itemModal.classList.remove('hidden');
        };

        const openSaleModal = () => {
            saleItemIdSelect.innerHTML = '<option value="">-- Pilih Barang --</option>';
            stockData.forEach(item => { // This will now only have 2 items
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (${item.code})`;
                saleItemIdSelect.appendChild(option);
            });
            saleForm.reset();
            saleDateInput.valueAsDate = new Date();
            saleQuantityInput.value = 1;
            updateSalePrice();
            saleModal.classList.remove('hidden');
        };

        const updateSalePrice = () => {
            const selectedItemId = saleItemIdSelect.value;
            const selectedWarehouse = saleWarehouseSelect.value;
            const selectedCustomer = saleCustomerNameSelect.value;
            const item = stockData.find(i => i.id === selectedItemId);
            const quantity = parseInt(saleQuantityInput.value) || 0;

            if (item && selectedWarehouse) {
                const { finalStock } = calculateStock(item.code, selectedWarehouse);
                availableStockInfo.textContent = `Stok di ${selectedWarehouse}: ${finalStock} ${item.unit}`;
                
                // NEW LOGIC: Get price from customer pricing table
                const customerPrice = hargaPelanggan[selectedCustomer]?.[item.name];
                const finalPrice = (customerPrice !== undefined && customerPrice > 0) ? customerPrice : (item.harga || 0);

                saleItemPriceDisplay.textContent = formatCurrency(finalPrice);
                saleTotalPriceDisplay.textContent = formatCurrency(finalPrice * quantity);
            } else {
                availableStockInfo.textContent = 'Pilih gudang dan barang.';
                saleItemPriceDisplay.textContent = formatCurrency(0);
                saleTotalPriceDisplay.textContent = formatCurrency(0);
            }
        };

        const saveForecast = () => {
            forecastView.querySelectorAll('.forecast-input').forEach(input => {
                const customer = input.dataset.customer;
                const item = input.dataset.item;
                if (!forecastData[customer]) forecastData[customer] = {};
                forecastData[customer][item] = parseInt(input.value) || 0;
                input.classList.remove('forecast-dirty');
            });
            saveData();
            refreshAll();
            showToast("Data forecast berhasil disimpan!");
        };

        // --- SECTION: Event Listeners ---
        
        // Theme toggle is removed as we force dark mode
        // themeToggle.addEventListener('click', ...);

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const tab = button.dataset.tab;
                document.querySelectorAll('#main-app > .glass-container > div[id$="-view"]').forEach(view => view.classList.add('hidden'));
                document.getElementById(`${tab}-view`).classList.remove('hidden');
            });
        });
        searchInput.addEventListener('input', (e) => renderStockTable(e.target.value));

        addStockBtn.addEventListener('click', openAddStockModal);
        recordSaleBtn.addEventListener('click', openSaleModal);
        printSalesBtn.addEventListener('click', () => window.print());
        printStockBtn.addEventListener('click', () => window.print());
        saveForecastBtn.addEventListener('click', saveForecast);
        saveAllocationBtn.addEventListener('click', () => {
            allocationTableBody.querySelectorAll('input').forEach(input => {
                const gudang = input.dataset.gudang;
                const item = input.dataset.item;
                if(!gudangAllocations[gudang]) gudangAllocations[gudang] = {};
                gudangAllocations[gudang][item] = parseInt(input.value) || 0;
            });
            saveData();
            showToast('Alokasi gudang berhasil disimpan!');
        });

        document.querySelectorAll('.close-modal-btn, .cancel-modal-btn, #close-confirmation-modal-btn, #cancel-confirmation-btn').forEach(btn => {
            btn.addEventListener('click', (e) => e.target.closest('.modal-container').classList.add('hidden'));
        });

        itemNameSelect.addEventListener('change', (e) => {
            const selectedName = e.target.value;
            const item = DEFAULT_ITEMS.find(i => i.name === selectedName);
            if (item) itemCodeSelect.value = item.code;
        });
        itemCodeSelect.addEventListener('change', (e) => {
            const selectedCode = e.target.value;
            const item = DEFAULT_ITEMS.find(i => i.code === selectedCode);
            if (item) itemNameSelect.value = item.name;
        });

        itemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const stockEntryId = document.getElementById('stock-entry-id').value;

            if (stockEntryId) { // Mode "Edit Pemasukan Stok"
                const entryToUpdate = stockEntries.find(e => e.id === stockEntryId);
                if (entryToUpdate) {
                    let updatedQuantity = 0;
                    // Find the single visible input to get the new quantity
                    warehouseStockInputsContainer.querySelectorAll('input[data-warehouse]').forEach(input => {
                        if (input.closest('div').style.display !== 'none') {
                            updatedQuantity = parseInt(input.value) || 0;
                        }
                    });
                    
                    if (updatedQuantity > 0) {
                         entryToUpdate.date = itemDateInput.value;
                         entryToUpdate.quantity = updatedQuantity;
                         showToast('Entri stok berhasil diperbarui!');
                    } else {
                        // If quantity is set to 0, it's like deleting it.
                        stockEntries = stockEntries.filter(e => e.id !== stockEntryId);
                        showToast('Entri stok dihapus karena jumlah 0.');
                    }
                }
            } else { // Mode "Tambah Stok Masuk"
                const code = itemCodeSelect.value;
                if (!code) return showToast("Kode Barang tidak valid.", true);

                let stockAdded = false;
                warehouseStockInputsContainer.querySelectorAll('input').forEach(input => {
                    const quantity = parseInt(input.value) || 0;
                    if (quantity > 0) {
                        stockEntries.push({ id: crypto.randomUUID(), date: itemDateInput.value, itemCode: code, warehouse: input.dataset.warehouse, quantity });
                        stockAdded = true;
                    }
                });
                if (stockAdded) {
                    showToast('Stok berhasil ditambahkan!');
                } else {
                    showToast('Tidak ada jumlah stok yang diinput.', true);
                    return;
                }
            }
            
            saveData();
            refreshAll();
            itemModal.classList.add('hidden');
        });

        saleForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const itemId = saleItemIdSelect.value;
            const quantity = parseInt(saleQuantityInput.value);
            const warehouse = saleWarehouseSelect.value;
            const customer = saleCustomerNameSelect.value;
            const item = stockData.find(i => i.id === itemId);

            if (!item || !warehouse) return showToast('Harap pilih barang dan gudang.', true);
            const { finalStock } = calculateStock(item.code, warehouse);
            if (quantity > finalStock) return showToast(`Stok di ${warehouse} tidak mencukupi! Stok tersedia: ${finalStock}`, true);
            
            const customerPrice = hargaPelanggan[customer]?.[item.name];
            const finalPrice = (customerPrice !== undefined && customerPrice > 0) ? customerPrice : (item.harga || 0);

            salesData.push({ id: crypto.randomUUID(), itemId, quantity, gudang: warehouse, hargaSatuan: finalPrice, totalHarga: finalPrice * quantity, date: new Date(saleDateInput.value).toISOString(), namaPelanggan: customer, nomorPO: salePoNumberInput.value.trim(), nomorSJ: saleSjNumberInput.value.trim(), keterangan: saleKeteranganInput.value.trim() });
            saveData();
            refreshAll();
            saleModal.classList.add('hidden');
            showToast('Pengiriman berhasil dicatat!');
        });
        
        stockView.addEventListener('click', (e) => {
            const editEntryBtn = e.target.closest('.edit-stock-entry-btn');
            if (editEntryBtn) {
                openEditStockEntryModal(editEntryBtn.dataset.id);
                return;
            }

            const deleteEntryBtn = e.target.closest('.delete-stock-entry-btn');
            if (deleteEntryBtn) {
                const entryId = deleteEntryBtn.dataset.id;
                showConfirmationModal('Apakah Anda yakin ingin menghapus entri pemasukan stok ini?', () => {
                    stockEntries = stockEntries.filter(entry => entry.id !== entryId);
                    saveData();
                    refreshAll();
                    showToast('Entri pemasukan stok berhasil dihapus.');
                });
                return;
            }
            
            const sortHeader = e.target.closest('.sortable-header');
            if(sortHeader) {
                const sortKey = sortHeader.dataset.sortBy;
                if (currentSort.key === sortKey) {
                    currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = sortKey; currentSort.order = 'asc';
                }
                renderStockTable(searchInput.value);
            }
        });
        
        salesTableBody.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-sale-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                showConfirmationModal('Apakah Anda yakin ingin menghapus data pengiriman ini?', () => {
                    salesData = salesData.filter(sale => sale.id !== id);
                    saveData();
                    refreshAll();
                    showToast('Data pengiriman dihapus.');
                });
            }
        });

        [saleCustomerNameSelect, saleItemIdSelect, saleWarehouseSelect, saleQuantityInput].forEach(el => {
            el.addEventListener('change', updateSalePrice);
            el.addEventListener('input', updateSalePrice);
        });

        forecastView.addEventListener('input', (e) => {
            if (e.target.matches('.forecast-input')) {
                e.target.classList.add('forecast-dirty');
            }
        });

        forecastView.addEventListener('change', (e) => {
            if (e.target.matches('.gudang-select')) {
                const customer = e.target.dataset.customer;
                const item = e.target.dataset.item;
                if(!dcToGdMap[customer]) dcToGdMap[customer] = {};
                dcToGdMap[customer][item] = e.target.value;
                saveData(); // Save mapping immediately on change
                renderGudangSummaryTable(); // Re-render the summary table on change
                renderAllocationTable(); // Also re-render allocation table
            }
        });

        addUserForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value;
            if(!username || !password) return showToast('Username dan Password tidak boleh kosong.', true);
            if (users.find(u => u.username === username)) return showToast('Username sudah digunakan.', true);
            users.push({ id: crypto.randomUUID(), username, password, role: document.getElementById('new-user-role').value });
            saveData(); renderUsersTable(); showToast('Pengguna baru berhasil ditambahkan.'); addUserForm.reset();
        });

        usersTableBody.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-user-btn');
            if (deleteBtn) {
                const userId = deleteBtn.dataset.id;
                showConfirmationModal('Apakah Anda yakin ingin menghapus pengguna ini?', () => {
                    users = users.filter(user => user.id !== userId);
                    saveData(); renderUsersTable(); showToast('Pengguna berhasil dihapus.');
                });
            }
        });

        saveCustomerPricesBtn.addEventListener('click', () => {
            customerPricesTableBody.querySelectorAll('input').forEach(input => {
                const customer = input.dataset.customer; const item = input.dataset.item; const price = parseFloat(input.value) || 0;
                if (!hargaPelanggan[customer]) hargaPelanggan[customer] = {};
                hargaPelanggan[customer][item] = price;
            });
            saveData();
            showToast('Harga untuk pelanggan berhasil disimpan.');
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const foundUser = users.find(u => u.username === loginForm.username.value && u.password === loginForm.password.value);
            if (foundUser) {
                sessionStorage.setItem('currentUser', JSON.stringify(foundUser));
                currentUser = foundUser;
                initializeApp();
            } else {
                loginError.textContent = 'Username atau password salah.';
            }
        });

        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('currentUser');
            currentUser = null;
            loginOverlay.classList.remove('hidden');
            mainApp.classList.add('hidden');
            loginForm.reset();
        });

        exportStockBtn.addEventListener('click', exportStockToExcel);
        importStockBtn.addEventListener('click', () => importStockFileInput.click());
        importStockFileInput.addEventListener('change', importStockFromExcel);
        exportSalesBtn.addEventListener('click', exportSalesToExcel);
        importSalesBtn.addEventListener('click', () => importSalesFileInput.click());
        importSalesFileInput.addEventListener('change', importSalesFromExcel);
        exportForecastBtn.addEventListener('click', exportForecastToExcel);
        importForecastBtn.addEventListener('click', () => importForecastFileInput.click());
        importForecastFileInput.addEventListener('change', importForecastFromExcel);
        exportAllocationBtn.addEventListener('click', exportAllocationToExcel);
        importAllocationBtn.addEventListener('click', () => importAllocationFileInput.click());
        importAllocationFileInput.addEventListener('change', importAllocationFromExcel);
        exportPricesBtn.addEventListener('click', exportCustomerPricesToExcel);
        importPricesBtn.addEventListener('click', () => importPricesFileInput.click());
        importPricesFileInput.addEventListener('change', importCustomerPricesFromExcel);

        const initializeApp = () => {
            loginOverlay.classList.add('hidden');
            mainApp.classList.remove('hidden');
            loginError.textContent = '';
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            applyTheme('dark'); // Force dark theme
            generateWarehouseInputs(); populateWarehouseSelects(); populateCustomerSelect();
            refreshAll(); applyPermissions();
        };

        loadData();
        const userJson = sessionStorage.getItem('currentUser');
        if (userJson) {
            currentUser = JSON.parse(userJson);
            initializeApp();
        } else {
             loginOverlay.classList.remove('hidden');
             mainApp.classList.add('hidden');
        }

        // Apply common styling classes
        document.querySelectorAll('.modal-label').forEach(label => label.classList.add('block', 'text-sm', 'font-medium', 'text-gray-300'));
        document.querySelectorAll('.modal-container').forEach(el => el.classList.add('fixed', 'inset-0', 'bg-black', 'bg-opacity-75', 'flex', 'items-center', 'justify-center', 'p-4', 'no-print', 'z-50'));
        document.querySelectorAll('.modal-header').forEach(el => el.classList.add('flex', 'justify-between', 'items-center', 'p-4', 'border-b', 'border-slate-700'));
        document.querySelectorAll('.modal-footer').forEach(el => el.classList.add('flex', 'justify-end', 'gap-3', 'pt-4', 'p-6', 'border-t', 'border-slate-700'));
        document.querySelectorAll('.close-modal-btn').forEach(el => el.classList.add('text-gray-400', 'hover:text-white', 'text-2xl', 'font-bold'));
        document.querySelectorAll('.cancel-modal-btn').forEach(el => el.classList.add('px-4', 'py-2', 'rounded-lg', 'bg-gray-600', 'hover:bg-gray-500'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.add('py-4', 'px-1', 'border-b-2', 'border-transparent', 'text-sm', 'font-medium', 'text-gray-400', 'hover:text-gray-300', 'hover:border-gray-600', 'transition-colors'));
    
    });
    </script>
</body>
</html>

